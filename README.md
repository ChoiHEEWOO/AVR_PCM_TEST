# 품평회 멘토링
> ATMEGA128 PCM TEST
 


## AVR을 이용한 PCM 오르골



### TICK타이머 구현

타이밍을 중요하게 고려해주어야 하는 시스템의 경우 tick 타이머가 큰 도움이 된다. 

대부분 tick 타이머는 1ms(1kHz)짜리 타이머를 만들어주는 것이 일반적인 것 같다. 각 개발자들 마다 의도하는 바가 다를 수 있기 때문에 항상 1ms라고 단정지을 수는 없지만, 여튼 대부분이 1ms로 만들어놓고 사용한다. 








### GPIO 입력부 구현

24개 키 입력을 동시에 받는 일은 쉽지 않다. (버튼, 스위치 같은 하드웨어상의 부품들은 풀업/풀다운을 통해 로직상태를 확실히 보장도 해주어야 하며, 뿐만 아니라 채터링 이슈까지도 신경 써줘야 한다.)
그렇기 때문에 가장 일반적인 생각으로는 버튼 하나에 풀업 또는 풀다운 저항이 구성되어야 하며, 채터링을 방지하고자 바이패스 커패시터 또한 구성되어야 한다. 

그런데 24개 버튼 모두에 저항과 커패시터를 달아준다는 일은 여간 쉬운 일이 아니다. 다만 이런 과정을 거쳐준 다면, 버튼 입력에 노이즈가 끼는 현상이 줄어들며, LOW/HIGH신호가 정상적으로 입력되는 것이 보장된다. 즉, MCU에 연결된 버튼의 경우 이상한 데이터가 들어오지 않고 개발자가 원하는 데이터가 정상적으로 들어오기 때문에 코드 작성하는데 고려해줘야 되는 부분이 덜해진다.

앞서 말했지만, 버튼 24개에 각각 저항과 커패시터를 달아주는 것은 번거로우며 회로 사이즈가 커지기도 하며, 양산을 한다면 단가가 상승하는 원인이 될 수 있다. 그렇다면, 이에 대한 해결책은 저항과 커패시터를 달지 않고 풀업/다운을 처리해줄 수 있고, 채터링 또한 잡아줄 수 있는 어떤 시스템을 소프트웨어를 통해 구현해주는 것이다. 다만, 코드가 조금 복잡해지는 것은 피해갈 수 없다.

여기서 Trade Off가 발생할 수 있다. 코드의 복잡도 <--> 회로의 복잡도  


### 문제 발생 및 고려 사항 등등

 - 인터럽트 발생 빈도가 너무 빠르다면 다른 시스템에 영향을 준다. 예를 들어, TIM0 비교매치 인터럽트 주기가 32kHz인데, 이것 말고도 다른 인터럽트(A인터럽트라고 가정)도 사용을 한다고 할 때,
 A 인터럽트는 10ms마다 발생한다고 칠 때, TIM0 비교매치 인터럽트가 A 인터럽트가 발생하는 순간순간마다 뺏어가는 상황들이 발생하여 A 인터럽트 동작에 부정적인 영향을 끼친다. 
 
 
 - 뿐만 아니라, main루프에도 좋지 않은 영향을 미친다. main 루프에 딜레이가 들어가는 상황을 만드는 것은 가급적 피하는 것이 좋다. 만일 인터럽트가 너무 자주 발생한다면 이는 마치 main루프에 딜레이를 거는것과 비슷한 결과를 낳는다. 

 - 해당 문제에 대한 결론은 다음과 같다. 
   - 시스템 클럭이 16MHz인 것을 고려할 때, 32KHz속도로 발생하는 인터럽트를 만들어주는 것은 애초에 설계부터 잘못되었다.(16MHz로 동작하는 시스템에서 32kHz마다 발생하는 인터럽트는 시스템 오동작에 원인이 되기 쉽다.)
  
   - 해당 시스템에서 32KHz로 만들어줄 수 밖에 없는 상황이라면, ISR 루틴에 코드를 최대한 간결하게 작성해주어야 한다. 
  
   - 1ms짜리 tick Timer는 main문에서 만들어주도록 한다. 
  
   - 다음 부턴 비슷한 상황이 생긴다면, 인터럽트 발생 속도를 낮추던지, 시스템 클럭이 월등히 높은 MCU를 선정하는 판단이 필요하다. 
  
  
